:imagesdir: images
:numbered:
:icons: font

ifdef::env-github[]
//Exibe √≠cones para os blocos como NOTE e IMPORTANT no GitHub

:caution-caption: :fire:
:important-caption: :exclamation:
:note-caption: :paperclip:
:tip-caption: :bulb:
:warning-caption: :warning:
endif::[]

= Consumo de Servi√ßos de CEP com Quarkus e inje√ß√£o de depend√™ncias com CDI

IMPORTANT: https://www.youtube.com/playlist?list=PLyo0RUAM69UsD_HNhT0b41QxM8UAx4t6h[V√≠deo-aulas dispon√≠veis aqui]

Aplica√ß√£o de exemplo para consumo de servi√ßo REST de consulta de CEP utilizando o framework http://quarkus.io[Quarkus].
S√£o implementadas as classes ViaCepService e PostmonService para permitir consumir os servi√ßos
https://viacep.com.br[ViaCEP] e https://postmon.com.br[Postmon].

Abaixo √© mostrado um exemplo de URI para acesso a tais servi√ßos:

- https://viacep.com.br/ws/77021090/json
- https://api.postmon.com.br/v1/cep/77021090

√â utilizada inje√ß√£o de depend√™ncia para definir qual dos dois servi√ßos ser√° utilizado. 
O diagrama de classes a seguir apresenta a modelagem dos projetos:

image::cep-service.png[]

== Requisitos

== Requisitos

- JDK 8 ou 11
- Maven 3.6.3 ou superior

Mesmo as vers√µes mais atuais do NetBeans v√™m com vers√µes antigas do Maven que n√£o ir√° funcionar.

O maven pode ser instalado, por exemplo em distribui√ß√µes Linux baseadas em Debian, com:

[source,bash]
----
sudo apt-get install maven
----

No Windows, pode-se baixar um arquivo `apache-maven-x.x.x-bin.zip` em https://maven.apache.org/download.cgi. Voc√™ tamb√©m pode configurar o https://docs.microsoft.com/en-us/windows/wsl/install-win10[Windows Subsystem for Linux] e assim poder√° baixar aplica√ß√µes usando o mesmo comando Linux acima.

No NetBeans ent√£o √© poss√≠vel indicar que deseja-se utilizar uma vers√£o do Maven instalada no sistema, no lugar de usar a que vem com o NetBeans. 
Para isto, acesse as prefer√™ncias do NetBeans, depois a aba Java >> Maven e informe o caminho do comando "mvn" no campo "Maven Home".

== Executar o Projeto

Voc√™ pode iniciar o servidor com sua aplica√ß√£o de diferentes maneiras.

IMPORTANT: Nos dois m√©todos apresentados abaixo, se voc√™ estiver usando Windows,
deve trocar `mvnw` por `mvnw.cmd`.

=== Usando o script mvnw

O script `mvnw` √© inclu√≠do durante a cria√ß√£o do projeto, assim, basta executar o comando abaixo na raiz do projeto:

```bash
./mvnw compile quarkus:dev
```

== Usando o maven-exec-plugin

Voc√™ pode clicar no bot√£o Play em IDEs como o NetBeans, pois foi inclu√≠do o plugin maven-exec para executar o comando acima mais facilmente.
Caso voc√™ esteja criando o projeto do zero, o plugin maven-exec n√£o ser√° inclu√≠do
e voc√™ deve inclu√≠-lo dentro da tag `<plugins>` no arquivo pom.xml, como
mostrado abaixo:

```xml
<plugin>
  <groupId>org.codehaus.mojo</groupId>
  <artifactId>exec-maven-plugin</artifactId>
  <version>1.6.0</version>
  <configuration>
    <executable>./mvnw</executable>
    <arguments>
      <argument>clean</argument>
      <argument>compile</argument>
      <argument>quarkus:dev</argument>
    </arguments>
  </configuration>
</plugin>
```

==== Atualizando o projeto sem reiniciar o servidor

Bem, atualizar o projeto no servidor em execu√ß√£o e ver as altera√ß√µes que voc√™ fez na sua aplica√ß√£o √© realmente complicado com o Quarkus: voc√™ precisa apenas salvar o projeto e boom: normalmente em menos de 1 segundo a aplica√ß√£o estar√° rodando com as novas altera√ß√µes üò±üöÄüòÅ.

N√£o √© √† toa que o slogan do Quarkus √© "Supersonic Subatomic Java".

==== Acessando a aplica√ß√£o

Se voc√™ estiver habituado a usar servidores como o GlassFish no NetBeans,
sabe que ao clicar no bot√£o Play, o projeto √© compilado e executado,
abrindo o navegador automaticamente.
Usando o Quarkus isso n√£o ocorrer√°.
Voc√™ deve abrir o navegador voc√™ mesmo. Neste caso, a aplica√ß√£o estar√° dispon√≠vel
em http://localhost:8080.
Observe que n√£o h√° um caminho adicional com o nome da aplica√ß√£o no final da URL,
pois a aplica√ß√£o executa na raiz do servidor.

== Detalhes dos Projetos

Estamos utilizando o framework CDI da plataforma Java para inje√ß√£o de depend√™ncias,
neste caso para injetar implementa√ß√µes do servi√ßo de busca de CEP.
Inje√ß√£o de depend√™ncias √© uma t√©cnica que permite instanciar objetos
sem precisar informar, no local onde deseja-se realizar a instancia√ß√£o, 
qual a classe concreta que ser√° utilizada para isto.

No caso dos servi√ßos de busca de CEP, temos a interface `CepService` e as classes
concretas `ViaCepService` e `PostmonService`. Do modo tradicional, podemos declarar um objeto de forma abstrata como `CepService`, mas no momento de instanciar temos que dizer exatamente qual classe concreta ser√° usada, como:

[source, java]
----
//Declara√ß√£o usando tipo abstrato (a interface CepService)
CepService service;
...
...
//Instancia√ß√£o usando tipo concreto (a subclasse ViaCepService)
service = new ViaCepService();
----

Com o CDI, podemos injetar inst√¢ncias de uma classe que implementa `CepService` apenas anotando a vari√°vel com `@Inject`, como:

[source, java]
----
/*Declara√ß√£o usando tipo abstrato (a interface CepService).
Com a anota√ß√£o @Inject, um objeto de uma classe concreta 
ser√° instanciado automaticamente quando necess√°rio.*/
@Inject
CepService service;
----

Observe que n√£o temos mais a linha que instancia o objeto. Qual dos dois servi√ßos (`ViaCepService` ou `PostmonService`) ser√° definido de forma centralizada utilizando o CDI. Assim, se precisarmos trocar uma implementa√ß√£o por outra, n√£o temos que sair alterando em todos os locais onde declaramos vari√°veis do tipo `CepService`.

O CDI funciona por padr√£o em qualquer projeto web que utilize um servidor de aplica√ß√£o
como Payara, GlassFish, WildFly e outros, sem exigir esfor√ßos de configura√ß√£o.

== C√≥digo Fonte

Existem duas vers√µes deste projeto dispon√≠veis em link:cep-service-default[cep-service-default] e link:cep-service-producer[cep-service-producer]. 
Veja a documenta√ß√£o deles para mais detalhes.

== Refer√™ncias

- Documenta√ß√£o do WELD: Implementa√ß√£o de Refer√™ncia do CDI
    * https://docs.jboss.org/weld/reference/latest/en-US/html/intro.html#_what_is_a_bean[What is a bean (documenta√ß√£o do WELD)]
    * https://docs.jboss.org/weld/reference/latest/en-US/html/scopescontexts.html[Scopes and contexts]
    * https://weld.cdi-spec.org/news/2016/10/25/tip3-performance/[Boost performance of Weld (CDI) apps]

- Documenta√ß√£o Oficial da Oracle (apesar de ser pra Java 7, continua v√°lida)
    * https://docs.oracle.com/javaee/7/tutorial/cdi-basic008.htm[The Java EE 6 Tutorial: Using Scopes]
    * https://docs.oracle.com/javaee/7/tutorial/cdi-basic004.htm[About CDI Managed Beans]
- http://cdi-spec.org[Site oficial da especifica√ß√£o CDI]
